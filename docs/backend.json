{
  "entities": {
    "Product": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Product",
      "type": "object",
      "description": "Represents a gluten-free product.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the product."
        },
        "name": {
          "type": "string",
          "description": "Name of the product."
        },
        "description": {
          "type": "string",
          "description": "Description of the product."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the product image.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "isAdmin": {
          "type": "boolean",
          "description": "Indicates if the user is an administrator."
        }
      },
      "required": [
        "id",
        "email"
      ]
    },
    "Vote": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Vote",
      "type": "object",
      "description": "Represents a user's vote on a product's safety and taste.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the vote."
        },
        "productId": {
          "type": "string",
          "description": "Reference to the Product being voted on. (Relationship: Product 1:N Vote)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User casting the vote. (Relationship: User 1:N Vote)"
        },
        "safetyRating": {
          "type": "number",
          "description": "Safety rating of the product. Values can be 'Clean', 'Sketchy', 'Wrecked'."
        },
        "tasteRating": {
          "type": "number",
          "description": "Taste rating of the product. Values can be 'Yass', 'Meh', 'Pass'."
        }
      },
      "required": [
        "id",
        "productId",
        "userId",
        "safetyRating",
        "tasteRating"
      ]
    },
    "Report": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Report",
      "type": "object",
      "description": "Represents a user report on a product.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the report."
        },
        "productId": {
          "type": "string",
          "description": "Reference to the Product being reported. (Relationship: Product 1:N Report)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User submitting the report. (Relationship: User 1:N Report)"
        },
        "reason": {
          "type": "string",
          "description": "Reason for reporting the product."
        },
        "isResolved": {
          "type": "boolean",
          "description": "Indicates if the report has been resolved by a moderator."
        }
      },
      "required": [
        "id",
        "productId",
        "userId",
        "reason"
      ]
    },
    "AdSlot": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AdSlot",
      "type": "object",
      "description": "Represents an advertisement slot within the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ad slot."
        },
        "name": {
          "type": "string",
          "description": "Name or identifier of the ad slot (e.g., 'Homepage Banner')."
        },
        "adType": {
          "type": "string",
          "description": "Type of advertisement (e.g., 'image', 'video')."
        },
        "contentUrl": {
          "type": "string",
          "description": "URL of the ad content.",
          "format": "uri"
        },
        "clickThroughUrl": {
          "type": "string",
          "description": "URL to redirect to when the ad is clicked.",
          "format": "uri"
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the ad slot is currently active."
        }
      },
      "required": [
        "id",
        "name",
        "adType",
        "contentUrl",
        "clickThroughUrl"
      ]
    },
    "AnalyticsEvent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AnalyticsEvent",
      "type": "object",
      "description": "Represents an analytics event tracked within the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the analytics event."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User associated with the event. (Relationship: User 1:N AnalyticsEvent)"
        },
        "eventType": {
          "type": "string",
          "description": "Type of event (e.g., 'product_search', 'vote_cast')."
        },
        "eventData": {
          "type": "string",
          "description": "Additional data associated with the event (e.g., search query, product ID)."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the event occurred.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "eventType",
        "timestamp"
      ]
    }
  },
  "auth": {
    "providers": [
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Stores product information. Includes a unique product ID.",
          "params": [
            {
              "name": "productId",
              "description": "Unique identifier for the product."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. Includes user ID and email.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/products/{productId}/votes/{userId}",
        "definition": {
          "entityName": "Vote",
          "schema": {
            "$ref": "#/backend/entities/Vote"
          },
          "description": "Stores user votes for each product. Uses a composite key of productId and userId for direct access and to ensure a user can only vote once per product.",
          "params": [
            {
              "name": "productId",
              "description": "Unique identifier for the product."
            },
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/products/{productId}/reports/{reportId}",
        "definition": {
          "entityName": "Report",
          "schema": {
            "$ref": "#/backend/entities/Report"
          },
          "description": "Stores reports for each product, created by users.  Allows moderators to review and resolve reports.",
          "params": [
            {
              "name": "productId",
              "description": "Unique identifier for the product."
            },
            {
              "name": "reportId",
              "description": "Unique identifier for the report."
            }
          ]
        }
      },
      {
        "path": "/ad_slots/{adSlotId}",
        "definition": {
          "entityName": "AdSlot",
          "schema": {
            "$ref": "#/backend/entities/AdSlot"
          },
          "description": "Stores ad slot information.  Allows administrators to manage ads.",
          "params": [
            {
              "name": "adSlotId",
              "description": "Unique identifier for the ad slot."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/analytics_events/{eventId}",
        "definition": {
          "entityName": "AnalyticsEvent",
          "schema": {
            "$ref": "#/backend/entities/AnalyticsEvent"
          },
          "description": "Stores analytics events for each user. Used for tracking user activity.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "eventId",
              "description": "Unique identifier for the analytics event."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Indicates admin privileges. The existence of a document with the user's ID in this collection grants admin rights.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore structure is designed to support the G-Matrix application, emphasizing security, scalability, and ease of debugging. The core principle is **Authorization Independence**, achieved through denormalization, to avoid `get()` calls in security rules and enable atomic operations.\n\n**Products:** Products are stored in a top-level `/products` collection. Reports and votes related to a product are stored in subcollections.  This enables efficient product listing and searching.\n\n**User Data:** User profiles are stored in `/users/{userId}`. User-specific data, such as analytics events, are stored in subcollections under the user's document.\n\n**Votes:** Votes for each product are stored in a subcollection `/products/{productId}/votes/{userId}`. This allows efficient querying of votes for a specific product and avoids authorization issues.\n\n**Reports:** Product reports are stored in a subcollection `/products/{productId}/reports/{reportId}`. This keeps reports associated with their products and allows efficient retrieval for moderation. An `isResolved` field allows moderators to track the status of reports. Admins can manage these reports.\n\n**Analytics Events:** Analytics events are stored under `/users/{userId}/analytics_events/{eventId}`. This allows tracking user-specific activities.\n\n**Ad Slots:** Ad slots are stored in a top-level `/ad_slots` collection, managed by admins.\n\n**Admin Roles:** Admin privileges are determined by the existence of a document in the `/roles_admin/{userId}` collection. This simplifies admin role management and avoids custom claims.\n\n**Authorization Independence (Denormalization):** The design avoids hierarchical dependencies. For example, vote documents don't need to fetch product data to validate permissions.  All necessary context is available within the vote document itself (though in this example it is implicit via the path).\n\n**QAPs (Rules Are Not Filters):** The structure enables secure `list` operations. For example, listing votes for a product is secure because votes are stored in a subcollection of the product.  Admin roles are managed using the existence of documents in `/roles_admin/{userId}`, making it efficient to check admin privileges.\n\n**Invariants:** The structure supports ownership invariants by using path-based ownership where applicable (e.g., `/users/{userId}/analytics_events/{eventId}`). Timestamps are stored directly within the analytics events."
  }
}
    